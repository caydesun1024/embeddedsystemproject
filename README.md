## 📝 스마트 블라인드 시스템 텀 프로젝트 결과 보고서

**과목명:** 임베디드 시스템 설계 및 실험
**담당교수:** 김원석
**제출일:** 2024/12/23
**학과:** 정보컴퓨터공학부
**팀장:** 김대욱
**팀원:** 설종환, 박정민, 이승원

---

### 1. 프로젝트 개요 (Overview)

본 프로젝트는 스마트 블라인드 시스템을 개발하여 현대 가정 및 사무실 환경에서의 **편리성**, **에너지 절약**, **사용자 경험 개선**을 목표로 합니다. 여러 센서와 블루투스 모듈을 활용하여 환경 조건이나 사용자의 원격 명령에 따라 블라인드를 자동으로 제어하는 임베디드 시스템을 구현했습니다.

---

### 2. 주요 개발 내용 및 기술 요약 (Key Features and Technology Summary)

#### 2.1. 기능 구현
| 기능 | 구현 방식 | 설명 |
|:---|:---|:---|
| **환경 센서 기반 자동 제어** | ADC1 및 두 채널(조도, 온도) 기반 데이터 변환 | **조도 센서 (GL5537)** 측정값이 임계값 (4000 lux)을 초과할 때만 **온도 센서 (LM35DZ)**를 활성화하여 에너지 소비를 절감합니다. 온도가 임계값 (28도) 이상이면 블라인드가 자동으로 내려갑니다. |
| **블루투스 및 유선 수동 제어** | UART2/UART1 인터럽트를 활용한 명령 수신 및 처리 | **블루투스 (UART2)** 모듈을 통해 스마트폰 앱으로 원격 제어가 가능하며, **유선 (UART1)** 명령을 통해 PC에서도 제어할 수 있습니다. 명령은 **'u'(올리기)**, **'d'(내리기)**, **'s'(정지)**로 구성됩니다. |
| **모터 제어 및 안전 장치** | GPIO 기반 모터 방향 및 속도 제어 | 모터 2개와 L298N 모터 드라이브를 사용하여 블라인드의 상하를 제어합니다. 블라인드가 이미 최상단/최하단에 있는 경우 추가 명령은 무시됩니다. |
| **명령 처리 안정화** | 고정 크기의 **명령 큐 (command Queue)** 구현 | UART 통신 과정에서 데이터 수신 속도와 처리 속도의 불일치로 명령이 무시되는 현상을 해결하기 위해 명령을 Queueing하여 안정적으로 처리합니다. |
| **LCD 디스플레이 정보 제공** | LCD\_ShowString 함수로 상태와 데이터를 실시간 표시 | 블라인드 상태 ("blind up", "blind down", "stopped"), 현재 조도/온도 데이터, 그리고 에러 메시지 ("Full Queue", "Already Up", "Already Down")를 실시간으로 표시합니다. |

#### 2.2. 하드웨어 설정 (Configuration Summary)
| 설정 항목 | 주요 내용 |
|:---|:---|
| **클럭 (RCC)** | GPIO A, B, C, D 포트, USART1/2, AFIO, ADC1 클럭 활성화. |
| **GPIO** | UART1 (PA9, PA10), UART2 (PA2, PA3), 모터 1 (PB1, PB2), 모터 2 (PD1, PD2), 센서 (조도: PC2, 온도: PC1) 핀 설정. |
| **ADC** | ADC1을 독립 모드, 단일 채널 모드로 설정. EOC 인터럽트 활성화. 초기 채널은 조도 센서 (ADC\_Channel\_12). |
| **USART** | USART1, USART2 모두 9600 BaudRate, 8비트, 패리티 없음, 1 Stop Bit로 설정. RXNE 인터럽트 활성화. |
| **NVIC** | USART 인터럽트 (**높은 우선순위**)를 ADC 인터럽트 (**낮은 우선순위**)보다 높게 설정하여 실시간 통신 보장. |

---

### 3. 주요 알고리즘 및 시스템 동작

#### 3.1. 명령 큐 및 UART 인터럽트
* `enqueueCommand()`: 외부에서 수신된 명령을 큐에 저장합니다. 큐가 가득 찬 경우 `stateString`을 "**Full Queue**"로 설정합니다.
* `USART1_IRQHandler()` / `USART2_IRQHandler()`: UART로 명령 수신 시 플래그(`flagUART1` 또는 `flagUART2`)를 설정하고, 수신된 명령을 **명령 큐**에 저장합니다.
* **통신 흐름:**
    * **PC/스마트폰 → USART1/2 IRQ → 큐 저장**
    * **메인 루프:** `flagUART`를 확인하여 큐에서 명령을 꺼내(`dequeueCommand()`) 처리합니다.
        * **USART1 처리:** 수신한 명령을 USART2로 전달 (블루투스 장치로 전송).
        * **USART2 처리:** 수신한 명령을 USART1로 전달 (PC로 전송)하고 **Motor\_Control**을 수행합니다.

#### 3.2. ADC 센서 제어 및 인터럽트 (`ADC1_2_IRQHandler`)
1.  **조도 측정:** 초기 상태에서는 조도 센서 (채널 12) 값을 읽습니다.
2.  **온도 센서 활성화:** 조도 값이 **4000 lux**를 초과하면 `tempSensorActive`를 `true`로 설정하고 채널을 **온도 센서 (채널 11)**로 전환합니다.
3.  **온도 측정 및 자동 제어:** 온도 센서 값으로 계산한 온도가 **$28^\circ \text{C}$** 이상이면 `Blind_Down()` 함수를 호출합니다.
4.  **조도 센서로 복귀:** 자동 제어 완료 후 `tempSensorActive`를 `false`로 설정하고 채널을 다시 조도 센서로 전환합니다.
    * **채널 전환 시 처리:** 채널 전환 후 첫 번째 변환 값은 부정확하므로 무시하며, 매 채널 전환 시 ADC 보정(Calibration)을 수행합니다.

#### 3.3. 모터 제어 (`Blind_Up`, `Blind_Down`)
* **상태 확인:** 블라인드의 현재 위치를 `blindPosition` (FSM 구조)을 통해 확인합니다. 이미 최상단/최하단일 경우 LCD에 "**Already Up**" 또는 "**Already Down**" 메시지를 표시하고 동작을 무시합니다.
* **모터 구동:** `BLIND_POSITION_MOVING` 상태로 설정한 후, 모터 1 (PB1, PB2)과 모터 2 (PD1, PD2)의 GPIO 비트 설정을 통해 정방향/역방향으로 회전시킵니다.
* **시간 제어:** 설정된 딜레이(`BLIND_UP_PERIOD`/`BLIND_DOWN_PERIOD`) 동안만 작동 후 `Blind_Stop()`을 호출하여 정지합니다.

---

### 4. 기존 계획과 달라진 개발 내용

| 항목 | 기존 계획 | 실제 구현 | 이유 및 결과 |
|:---|:---|:---|:---|
| **모터 속도 제어** | L298N 드라이버의 EN1, EN2 핀을 통한 **PWM 제어**로 블라인드 동작을 자연스럽게 구현. | PB1, PB2, PD1, PD2 핀을 이용한 **GPIO 제어**로 항상 **최대 속도**로 회전하도록 구현. | 기획된 핀(PB3, PB4, PB5 등)을 통한 PWM 제어가 작동하지 않았습니다. 시현 일정을 고려하여 PWM 제어를 포기하고 최대 속도로 구현하게 되었습니다. |
